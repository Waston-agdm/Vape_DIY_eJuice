<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DIY æœæ±è®¡ç®—å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 22px; height: 22px;
            background: #4ade80; cursor: pointer; border-radius: 50%;
        }
        #presetLibrarySection { transition: max-height 0.3s ease-out; overflow: hidden; }
        .collapsed { max-height: 0 !important; margin-top: 0 !important; }
        .expanded { max-height: 1200px !important; margin-top: 1rem !important; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
            <div>
                <h1 class="text-2xl font-bold text-green-400">âš¡ DIY æœæ±è®¡ç®—å™¨</h1>
                <p class="text-[10px] text-slate-500 uppercase tracking-widest font-mono">ç²¾å‡†è°ƒé…ç‰ˆ v2.0-Waston</p>
            </div>
            <div class="flex gap-2">
                <button onclick="saveCurrentRecipe()" class="px-3 py-2 text-xs bg-green-600 hover:bg-green-500 rounded text-white font-bold transition shadow-lg">ä¿å­˜é…æ–¹</button>
                <button onclick="resetCalculator()" class="px-3 py-2 text-xs bg-slate-700 rounded text-white transition">é‡ç½®</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="space-y-4">
                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-xl">
                    <h2 class="text-sm font-bold text-slate-400 mb-4 border-b border-slate-700 pb-2 text-center">1. æˆå“è®¾å®š (Target)</h2>
                    <div class="space-y-4">
                        <input type="text" id="recipeName" placeholder="ç»™ä½ çš„æœæ±å–ä¸ªåå­—..." class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 outline-none text-white text-sm focus:border-green-500 transition-colors">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] text-slate-500 mb-1 font-bold italic">ç›®æ ‡å®¹é‡ (ml)</label>
                                <input type="number" id="targetVol" value="30" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 outline-none text-white font-mono text-center text-lg">
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-500 mb-1 font-bold italic">ç›®æ ‡æµ“åº¦ (mg)</label>
                                <input type="number" id="targetStr" value="20" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 outline-none text-white font-mono text-center text-lg">
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] text-slate-500 mb-2 font-bold">
                                <span>æœŸæœ›æ¯”ä¾‹</span><span id="targetRatioDisplay" class="text-green-400">50 PG / 50 VG</span>
                            </div>
                            <input type="range" id="targetVgSlider" min="0" max="100" value="50" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb">
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-xl">
                    <h2 class="text-sm font-bold text-slate-400 mb-4 border-b border-slate-700 pb-2 text-center">2. åŸæ–™è®¾å®š (Base & Flavors)</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1 pl-1">åŸæ¶²æµ“åº¦ (mg)</label>
                            <input type="number" id="baseStr" value="250" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 outline-none text-white text-sm font-mono text-center">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1 pl-1">åŸæ¶²æº¶å‰‚</label>
                            <select id="baseType" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 outline-none text-white text-sm">
                                <option value="0">100% PG</option>
                                <option value="100">100% VG</option>
                                <option value="50">50/50 æ··åˆ</option>
                            </select>
                        </div>
                    </div>
                    <div id="flavorsContainer" class="space-y-3"></div>
                    <button onclick="addFlavor()" class="mt-4 text-xs text-purple-400 font-bold w-full py-2 bg-slate-900/50 rounded-lg border border-dashed border-slate-700 hover:bg-slate-900 transition">+ æ·»åŠ æˆåˆ† (é¦™ç²¾/å‡‰å‘³/ç”œå‘³)</button>
                </div>
            </div>

            <div class="space-y-4">
                <div id="warning-box" class="hidden p-4 bg-red-900/40 border border-red-500/50 rounded-xl text-red-200 text-[10px] animate-pulse"></div>
                <div class="bg-slate-800 rounded-2xl border border-slate-700 shadow-xl overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="text-[10px] text-slate-500 bg-slate-900/50 uppercase">
                            <tr><th class="px-5 py-3">é…æ–™æˆåˆ†</th><th class="px-5 py-3 text-right">éœ€åŠ å…¥ (ml)</th><th class="px-5 py-3 text-right">ç™¾åˆ†æ¯”</th></tr>
                        </thead>
                        <tbody id="resultBody" class="divide-y divide-slate-700/50 text-xs"></tbody>
                        <tfoot class="bg-slate-900/80 font-bold">
                            <tr><td class="px-5 py-4 text-slate-300">æˆå“æ€»é‡</td><td class="px-5 py-4 text-green-400 text-right font-mono text-xl" id="totalMl">30.00 ml</td><td class="px-5 py-4 text-right text-slate-500">100%</td></tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div class="mb-8">
            <button onclick="togglePresets()" class="flex items-center justify-between w-full text-xs font-bold text-sky-400 hover:text-sky-300 transition bg-slate-800/50 p-4 rounded-xl border border-slate-700 shadow-lg">
                <span class="flex items-center gap-2">â˜ï¸ Nimbus å®˜æ–¹é…æ–¹åº“ <span id="presetCount" class="text-[9px] bg-sky-900/50 px-2 py-0.5 rounded">0</span></span>
                <span id="presetChevron" class="transition-transform duration-300">â–¼</span>
            </button>
            <div id="presetLibrarySection" class="collapsed space-y-3">
                <div class="relative mt-4">
                    <input type="text" id="presetSearch" oninput="renderPresets()" placeholder="æœç´¢å®˜æ–¹é…æ–¹..." class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 pl-10 outline-none text-white text-xs focus:border-sky-500 transition-colors">
                    <span class="absolute left-3 top-3 text-slate-500">ğŸ”</span>
                </div>
                <div id="presetLibrary" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2"></div>
            </div>
        </div>

        <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700 shadow-xl">
            <h2 class="text-sm font-bold text-yellow-500 mb-5 flex items-center gap-2">ğŸ“ æˆ‘çš„ç§äººé…æ–¹</h2>
            <div id="recipeLibrary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </div>

<script>
    // ä¿æŒåŸæ¥çš„é¢„è®¾é…æ–¹æ•°æ®
    const PRESET_RECIPES = [
        { name: "NM-è‰è“çƒŸè‰", vg: 50, str: 20, flavors: [{name: "é¦™ç²¾", pct: 30}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 0}] },
        { name: "NM-è¥¿ç“œ", vg: 50, str: 20, flavors: [{name: "è¥¿ç“œé¦™ç²¾", pct: 25}, {name: "è‰è“é¦™ç²¾", pct: 5}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 5}] },
        { name: "NM-è“è“", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 20}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-åŠ æµ“è‰è“", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 20}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-å¯ä¹", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 20}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-çŸ¿æ³‰æ°´", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 20}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-è¥¿ç“œæ±", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 20}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-æ©™å­èŠ­ä¹", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 20}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-è«å‰æ‰˜", vg: 50, str: 20, flavors: [{name: "é¦™ç²¾", pct: 30}, {name: "ç”œå‘³å‰‚", pct: 0.5}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-èŒ‰è‰èŠå£«è›‹ç³•", vg: 44.5, str: 20, flavors: [{name: "é¦™ç²¾", pct: 30}, {name: "ç”œå‘³å‰‚", pct: 0.5}, {name: "å‡‰å‘³å‰‚", pct: 0}] },
        { name: "NM-è‰è“è”æè‘¡è„", vg: 43, str: 20, flavors: [{name: "é¦™ç²¾", pct: 15}, {name: "ç”œå‘³å‰‚", pct: 0.5}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-è è", vg: 40, str: 20, flavors: [{name: "é¦™ç²¾", pct: 30}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 6}, {name: "é…¸å‘³å‰‚", pct: 1}] },
        { name: "NM-ç™¾é¦™æœ", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 20}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 6}] },
        { name: "NM-ç™¾é¦™æœç•ªçŸ³æ¦´", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 30}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 3}] },
        { name: "NM-ç•™å…°é¦™è–„è·", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 20}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 8}] },
        { name: "NM-é»„æ¡ƒæœèŒ¶", vg: 40, str: 20, flavors: [{name: "é¦™ç²¾", pct: 40}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-å“ˆå¯†ç“œé¦™èŠ‹", vg: 40, str: 20, flavors: [{name: "é¦™ç²¾", pct: 30}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-æ¡ƒå­é›ªç¢§", vg: 40, str: 20, flavors: [{name: "é¦™ç²¾", pct: 26}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-å±±ç«¹æ¡‚åœ†æ¨æ¡ƒ", vg: 40, str: 20, flavors: [{name: "é¦™ç²¾", pct: 30}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}, {name: "é…¸å‘³å‰‚", pct: 0.5}] },
        { name: "NM-èœ‚èœœæŸšå­èŒ¶", vg: 50, str: 20, flavors: [{name: "é¦™ç²¾", pct: 30}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4.5}] }
    ];

    let flavors = PRESET_RECIPES[0].flavors; 
    let recipeBook = JSON.parse(localStorage.getItem('myVapeRecipes') || '[]');
    const els = {
        targetVol: document.getElementById('targetVol'),
        targetStr: document.getElementById('targetStr'),
        targetVgSlider: document.getElementById('targetVgSlider'),
        targetRatioDisplay: document.getElementById('targetRatioDisplay'),
        baseStr: document.getElementById('baseStr'),
        baseType: document.getElementById('baseType'),
        recipeName: document.getElementById('recipeName'),
        flavorsContainer: document.getElementById('flavorsContainer'),
        resultBody: document.getElementById('resultBody'),
        totalMl: document.getElementById('totalMl'),
        warningBox: document.getElementById('warning-box'),
        recipeLibrary: document.getElementById('recipeLibrary'),
        presetLibrarySection: document.getElementById('presetLibrarySection'),
        presetLibrary: document.getElementById('presetLibrary'),
        presetSearch: document.getElementById('presetSearch'),
        presetChevron: document.getElementById('presetChevron')
    };

    function togglePresets() {
        const isCollapsed = els.presetLibrarySection.classList.contains('collapsed');
        els.presetLibrarySection.classList.toggle('collapsed', !isCollapsed);
        els.presetLibrarySection.classList.toggle('expanded', isCollapsed);
        els.presetChevron.style.transform = isCollapsed ? 'rotate(180deg)' : 'rotate(0deg)';
    }

    function calculate() {
        const vol = parseFloat(els.targetVol.value) || 0;
        const targetNic = parseFloat(els.targetStr.value) || 0;
        const targetVgPct = parseInt(els.targetVgSlider.value);
        const targetPgPct = 100 - targetVgPct;
        const baseStr = parseFloat(els.baseStr.value) || 0;
        const baseVgPct = parseInt(els.baseType.value);
        
        els.warningBox.classList.add('hidden');
        if (vol <= 0) {
            els.resultBody.innerHTML = '';
            els.totalMl.innerText = '0.00 ml';
            return;
        }

        let nicVol = baseStr > 0 ? (targetNic * vol) / baseStr : 0;
        let flavVol = 0;
        let flavHtml = '';
        
        flavors.forEach(f => {
            let fv = vol * (f.pct / 100);
            flavVol += fv;
            if(fv > 0) flavHtml += renderRow(f.name || 'è°ƒå‘³é¦™ç²¾', fv, f.pct, 'text-purple-400');
        });

        let nicPg = nicVol * ((100 - baseVgPct)/100);
        let nicVg = nicVol * (baseVgPct/100);
        let extraVg = (vol * targetVgPct/100) - nicVg;
        let extraPg = (vol * targetPgPct/100) - nicPg - flavVol;

        if (extraVg < -0.01 || extraPg < -0.01) {
            els.warningBox.classList.remove('hidden');
            els.warningBox.innerText = "âš ï¸ è­¦å‘Šï¼šé¦™ç²¾æˆ–åŸæ¶²å æ¯”è¿‡é«˜ï¼Œå·²è¶…å‡ºé¢„è®¾æ¯”ä¾‹ã€‚";
        }

        let html = '';
        if(nicVol > 0) html += renderRow(baseStr + 'mg å°¼å¤ä¸åŸæ¶²', nicVol, (nicVol/vol*100), 'text-red-400 font-bold');
        html += flavHtml;
        html += renderRow('è¡¥é½ VG (ç”˜æ²¹)', Math.max(0, extraVg), (Math.max(0, extraVg)/vol*100), 'text-green-400 font-bold');
        html += renderRow('è¡¥é½ PG (ä¸™äºŒé†‡)', Math.max(0, extraPg), (Math.max(0, extraPg)/vol*100), 'text-blue-400 font-bold');
        
        els.resultBody.innerHTML = html;
        els.totalMl.innerText = vol.toFixed(2) + ' ml';
    }

    // æ¸²æŸ“è¡Œæ•°æ®ï¼šä¿ç•™ 2 ä½å°æ•°
    function renderRow(n, v, p, c) {
        return `<tr><td class="px-5 py-3 ${c}">${n}</td><td class="px-5 py-3 text-right font-mono font-bold">${v.toFixed(2)}</td><td class="px-5 py-3 text-right text-slate-500 text-[10px]">${p.toFixed(1)}%</td></tr>`;
    }

    function addFlavor() { flavors.push({ name: '', pct: 0 }); renderFlavors(); }
    function removeFlavor(i) { flavors.splice(i, 1); renderFlavors(); }

    function renderFlavors() {
        els.flavorsContainer.innerHTML = '';
        flavors.forEach((f, i) => {
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center';
            div.innerHTML = `<input type="text" value="${f.name}" oninput="flavors[${i}].name=this.value;calculate()" placeholder="æˆåˆ†åç§°" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs text-white outline-none focus:border-purple-500 transition-colors"><input type="number" value="${f.pct}" oninput="flavors[${i}].pct=parseFloat(this.value)||0;calculate()" class="w-16 bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs text-right text-white font-mono outline-none"><span class="text-slate-600 text-[10px]">%</span><button onclick="removeFlavor(${i})" class="text-slate-500 hover:text-red-500 px-1 text-xl">Ã—</button>`;
            els.flavorsContainer.appendChild(div);
        });
        calculate();
    }

    function loadToUI(r) {
        els.recipeName.value = r.name;
        els.targetStr.value = r.str;
        els.targetVgSlider.value = r.vg;
        els.targetRatioDisplay.innerText = `${100-r.vg} PG / ${r.vg} VG`;
        flavors = JSON.parse(JSON.stringify(r.flavors));
        renderFlavors();
        if (els.presetLibrarySection.classList.contains('expanded')) togglePresets();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function renderPresets() {
        const query = els.presetSearch.value.toLowerCase();
        const filtered = PRESET_RECIPES.filter(r => r.name.toLowerCase().includes(query));
        document.getElementById('presetCount').innerText = PRESET_RECIPES.length;
        els.presetLibrary.innerHTML = '';
        filtered.forEach(r => {
            const btn = document.createElement('button');
            btn.className = 'bg-sky-900/20 border border-sky-700/30 p-2.5 rounded-xl text-left hover:bg-sky-800/40 transition flex justify-between items-center group';
            btn.onclick = () => loadToUI(r);
            btn.innerHTML = `<div class="text-[10px] font-bold text-sky-300 group-hover:text-sky-100 truncate pr-1">${r.name}</div><div class="text-[8px] text-sky-600 font-bold italic flex-shrink-0">å¯¼å…¥</div>`;
            els.presetLibrary.appendChild(btn);
        });
    }

    function saveCurrentRecipe() {
        const recipe = { id: Date.now(), name: els.recipeName.value.trim() || "æœªå‘½åé…æ–¹", vol: els.targetVol.value, str: els.targetStr.value, vg: els.targetVgSlider.value, flavors: JSON.parse(JSON.stringify(flavors)) };
        recipeBook.unshift(recipe);
        localStorage.setItem('myVapeRecipes', JSON.stringify(recipeBook));
        renderLibrary();
        alert('âœ… é…æ–¹å·²ä¿å­˜');
    }

    function renderLibrary() {
        els.recipeLibrary.innerHTML = recipeBook.length ? '' : '<p class="text-slate-600 text-[10px] italic py-4">æš‚æ— ç§äººæ”¶è—...</p>';
        recipeBook.forEach(r => {
            const card = document.createElement('div');
            card.className = 'bg-slate-900/50 border border-slate-700 p-3 rounded-xl flex justify-between items-center';
            card.innerHTML = `<div class="truncate mr-2"><div class="font-bold text-xs text-slate-300 truncate">${r.name}</div><div class="text-[9px] text-slate-500 font-mono">${r.vg}VG Â· ${r.str}mg</div></div><div class="flex gap-2 flex-shrink-0"><button onclick='loadToUI(${JSON.stringify(r)})' class="text-[10px] text-yellow-600 font-bold px-2 py-1 bg-yellow-900/10 rounded">åŠ è½½</button><button onclick="deleteRecipe(${r.id})" class="text-[10px] text-red-900 px-2 py-1 font-bold">åˆ é™¤</button></div>`;
            els.recipeLibrary.appendChild(card);
        });
    }

    window.deleteRecipe = (id) => {
        if(!confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) return;
        recipeBook = recipeBook.filter(x => x.id !== id);
        localStorage.setItem('myVapeRecipes', JSON.stringify(recipeBook));
        renderLibrary();
    };

    window.resetCalculator = () => { if(confirm('é‡ç½®æ‰€æœ‰æ•°æ®ï¼Ÿ')) location.reload(); };
    document.querySelectorAll('input, select').forEach(el => el.addEventListener('input', calculate));
    els.targetVgSlider.addEventListener('input', (e) => { els.targetRatioDisplay.innerText = `${100 - e.target.value} PG / ${e.target.value} VG`; });

    renderFlavors();
    renderLibrary();
    renderPresets();
</script>
</body>
</html>
