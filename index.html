<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DIY æœæ±è®¡ç®—å™¨ - Waston-Agdm</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%20%2290%22>ğŸ§ª</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%231e293b%22/><text x=%2250%%22 y=%2265%%22 font-size=%2260%22 text-anchor=%22middle%22>ğŸ§ª</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <style>
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 24px; height: 24px;
            background: #4ade80; cursor: pointer; border-radius: 50%;
            border: 3px solid #1e293b;
        }
        #presetLibrarySection { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; }
        .collapsed { max-height: 0 !important; opacity: 0; transform: translateY(-10px); }
        .expanded { max-height: 2000px !important; opacity: 1; transform: translateY(0); margin-top: 1rem !important; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans min-h-screen p-4 md:p-8 flex flex-col antialiased">

    <div class="max-w-4xl mx-auto flex-grow w-full">
        <div class="flex justify-between items-end mb-8 border-b border-slate-700/50 pb-6">
            <div>
                <h1 class="text-3xl font-bold text-green-400 tracking-tight">âš¡ DIY æœæ±è®¡ç®—å™¨</h1>
                <p class="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-mono mt-1">ç³»ç»Ÿç‰ˆæœ¬ / Waston-Agdm v3.0</p>
            </div>
            <div class="flex gap-3">
                <button onclick="saveCurrentRecipe()" class="px-4 py-2 text-xs bg-green-600 hover:bg-green-500 rounded-xl text-white font-bold transition shadow-lg active:scale-90">ä¿å­˜é…æ–¹</button>
                <button onclick="resetCalculator()" class="px-4 py-2 text-xs bg-slate-800 hover:bg-slate-700 rounded-xl text-slate-300 transition active:scale-90">å…¨éƒ¨é‡ç½®</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="space-y-6">
                <div class="bg-slate-800/80 backdrop-blur-sm p-6 rounded-3xl border border-slate-700 shadow-2xl">
                    <h2 class="text-xs font-bold text-slate-500 mb-5 uppercase tracking-widest border-l-4 border-green-500 pl-3">1. æˆå“ç›®æ ‡è®¾å®š</h2>
                    <div class="space-y-5">
                        <input type="text" id="recipeName" placeholder="è¾“å…¥é…æ–¹åç§°..." class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 outline-none text-white text-base focus:ring-2 focus:ring-green-500/50 transition-all">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-900/50 p-3 rounded-2xl border border-slate-700/50">
                                <label class="block text-[10px] text-slate-500 mb-1 font-bold">ç›®æ ‡æ€»å®¹é‡ (ml)</label>
                                <input type="number" id="targetVol" value="30" class="w-full bg-transparent outline-none text-white font-mono text-2xl font-bold">
                            </div>
                            <div class="bg-slate-900/50 p-3 rounded-2xl border border-slate-700/50">
                                <label class="block text-[10px] text-slate-500 mb-1 font-bold">ç›®æ ‡å°¼å¤ä¸ (mg)</label>
                                <input type="number" id="targetStr" value="20" class="w-full bg-transparent outline-none text-white font-mono text-2xl font-bold">
                            </div>
                        </div>
                        
                        <div class="px-1 bg-slate-900/30 p-4 rounded-2xl border border-slate-700/30">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex flex-col">
                                    <span class="text-[9px] text-slate-600 uppercase font-bold tracking-tighter">Propylene Glycol</span>
                                    <span class="text-sm font-mono font-black text-slate-300">PG <span id="pgDisplay" class="text-lg">50</span></span>
                                </div>
                                <div class="flex flex-col items-end">
                                    <span class="text-[9px] text-slate-600 uppercase font-bold tracking-tighter">Vegetable Glycerin</span>
                                    <span class="text-sm font-mono font-black text-green-400">VG <span id="vgDisplay" class="text-lg">50</span></span>
                                </div>
                            </div>
                            <input type="range" id="targetVgSlider" min="0" max="100" value="50" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb">
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800/80 p-6 rounded-3xl border border-slate-700 shadow-2xl">
                    <h2 class="text-xs font-bold text-slate-500 mb-5 uppercase tracking-widest border-l-4 border-purple-500 pl-3">2. æº¶æ¶²ä¸é¦™ç²¾è®¾å®š</h2>
                    <div class="grid grid-cols-2 gap-4 mb-5">
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1 pl-1 font-bold text-red-400">å°¼å¤ä¸æº¶æ¶²æµ“åº¦</label>
                            <input type="number" id="baseStr" value="250" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 outline-none text-white font-mono text-lg text-center">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1 pl-1 font-bold">æº¶æ¶²åŸºåº•</label>
                            <select id="baseType" onchange="calculate()" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 outline-none text-white text-sm cursor-pointer appearance-none text-center">
                                <option value="0">å…¨ PG åŸºåº•</option>
                                <option value="100">å…¨ VG åŸºåº•</option>
                                <option value="50">50/50 æ··åˆ</option>
                            </select>
                        </div>
                    </div>
                    <div id="flavorsContainer" class="space-y-3"></div>
                    <button onclick="addFlavor()" class="mt-4 text-[11px] text-purple-400 font-bold w-full py-3 bg-purple-500/10 rounded-xl border border-dashed border-purple-500/30 hover:bg-purple-500/20 transition-all">+ æ·»åŠ é¦™ç²¾/æ·»åŠ å‰‚</button>
                </div>
            </div>

            <div class="space-y-6">
                <div id="warning-box" class="hidden p-4 bg-red-500/10 border border-red-500/50 rounded-2xl text-red-400 text-[11px] animate-pulse"></div>
                <div class="bg-slate-800 rounded-3xl border border-slate-700 shadow-2xl overflow-hidden">
                    <div class="p-5 border-b border-slate-700/50 bg-slate-800/50">
                        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest">ç²¾ç¡®è°ƒé…æ¸…å•</h2>
                    </div>
                    <table class="w-full text-left border-collapse">
                        <tbody id="resultBody" class="text-sm"></tbody>
                        <tfoot class="bg-slate-900/80">
                            <tr>
                                <td class="px-6 py-5 text-slate-400 font-bold text-[12px] tracking-widest uppercase">æ€»è®¡</td>
                                <td class="px-6 py-5 text-green-400 text-right font-mono text-3xl font-bold" id="totalMl">30.00</td>
                                <td class="pr-6 py-5 text-right text-slate-400 font-mono text-xs italic">ml</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div class="space-y-6 mb-12">
            <button onclick="togglePresets()" class="flex items-center justify-between w-full text-xs font-bold text-sky-400 bg-sky-500/5 p-5 rounded-2xl border border-sky-500/20 shadow-lg hover:bg-sky-500/10 transition-all">
                <span class="flex items-center gap-3 italic">â˜ï¸ NIMBUS é¦™ç²¾å‚è€ƒé…æ–¹ <span id="presetCount" class="text-[10px] bg-sky-500/20 px-2 py-0.5 rounded text-sky-300">0</span></span>
                <span id="presetChevron" class="text-lg transition-transform duration-300">â†“</span>
            </button>
            <div id="presetLibrarySection" class="collapsed">
                <div id="presetLibrary" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
            </div>
            <div class="bg-slate-800/30 p-6 rounded-3xl border border-slate-700/50 shadow-xl">
                <h2 class="text-xs font-bold text-yellow-600 mb-5 uppercase tracking-widest italic">â­ æˆ‘çš„ç§äººé…æ–¹</h2>
                <div id="recipeLibrary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>
    </div>

    <footer class="py-12 border-t border-slate-800 text-center space-y-8">
        <div class="max-w-2xl mx-auto px-6 space-y-6">
            <div class="bg-slate-950/40 p-5 rounded-2xl border border-slate-800/50">
                <p class="text-[10px] text-slate-500 leading-relaxed uppercase tracking-tight">
                    <span class="text-red-900/80 font-bold block mb-2">âš ï¸ å®‰å…¨å…è´£å£°æ˜</span>
                    æœ¬å·¥å…·ä»…ä¾› DIY çˆ±å¥½è€…ä½œä¸ºè®¡ç®—å‚è€ƒï¼Œä¸ä»£è¡¨ä¸“ä¸šå»ºè®®ã€‚å°¼å¤ä¸å…·æœ‰é«˜åº¦æˆç˜¾æ€§åŠæ¯’æ€§ï¼Œæ“ä½œæ—¶è¯·åŠ¡å¿…ä½©æˆ´é˜²æŠ¤æ‰‹å¥—ä¸æŠ¤ç›®é•œã€‚å› æ“ä½œä¸å½“æˆ–è®¡ç®—åå·®é€ æˆçš„ä»»ä½•åæœï¼Œæœ¬ç³»ç»ŸåŠä½œè€…æ¦‚ä¸è´Ÿè´£ã€‚
                    <br>
                    <span class="text-red-700 font-bold mt-1 block tracking-widest">ä¸¥ç¦æœªæˆå¹´äººä½¿ç”¨ | å¿…é¡»æ”¾ç½®åœ¨å„¿ç«¥ä¸å® ç‰©æ— æ³•è§¦åŠçš„åœ°æ–¹</span>
                </p>
            </div>

            <div class="flex flex-col items-center gap-4">
                <div class="flex justify-center items-center gap-6 text-slate-600 text-[10px] font-mono">
                    <span id="busuanzi_container_site_pv" style="display:none">è®¿é—®é‡ <span id="busuanzi_value_site_pv" class="text-slate-400 font-bold"></span></span>
                    <span id="busuanzi_container_site_uv" style="display:none">è®¿å®¢æ•° <span id="busuanzi_value_site_uv" class="text-slate-400 font-bold"></span></span>
                </div>
                <div class="space-y-1">
                    <p class="text-slate-500 text-[11px] font-medium tracking-wide">Â© 2024-2025 <span class="text-green-500/80">Waston-Agdm</span>. All Rights Reserved.</p>
                    <p class="text-slate-800 text-[9px] uppercase tracking-[0.4em]">WASTON-AGDM Project</p>
                </div>
            </div>
        </div>
    </footer>

<script>
    const PRESET_RECIPES = [
        { name: "NM-è‰è“çƒŸè‰", vg: 50, str: 20, flavors: [{name: "é¦™ç²¾", pct: 30}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 0}] },
        { name: "NM-è¥¿ç“œ", vg: 50, str: 20, flavors: [{name: "è¥¿ç“œ", pct: 25}, {name: "è‰è“", pct: 5}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 5}] },
        { name: "NM-è“è“", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 20}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-åŠ æµ“è‰è“", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 20}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-å¯ä¹", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 20}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-çŸ¿æ³‰æ°´", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 20}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-è¥¿ç“œæ±", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 20}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-æ©™å­èŠ­ä¹", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 20}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-è«å‰æ‰˜", vg: 50, str: 20, flavors: [{name: "é¦™ç²¾", pct: 30}, {name: "ç”œå‘³å‰‚", pct: 0.5}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-èŒ‰è‰èŠå£«è›‹ç³•", vg: 44.5, str: 20, flavors: [{name: "é¦™ç²¾", pct: 30}, {name: "ç”œå‘³å‰‚", pct: 0.5}, {name: "å‡‰å‘³å‰‚", pct: 0}] },
        { name: "NM-è‰è“è”æè‘¡è„", vg: 43, str: 20, flavors: [{name: "é¦™ç²¾", pct: 15}, {name: "ç”œå‘³å‰‚", pct: 0.5}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-è è", vg: 40, str: 20, flavors: [{name: "é¦™ç²¾", pct: 30}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 6}, {name: "é…¸å‘³å‰‚", pct: 1}] },
        { name: "NM-ç™¾é¦™æœ", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 20}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 6}] },
        { name: "NM-ç™¾é¦™æœç•ªçŸ³æ¦´", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 30}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 3}] },
        { name: "NM-ç•™å…°é¦™è–„è·", vg: 41, str: 20, flavors: [{name: "é¦™ç²¾", pct: 20}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 8}] },
        { name: "NM-é»„æ¡ƒæœèŒ¶", vg: 40, str: 20, flavors: [{name: "é¦™ç²¾", pct: 40}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-å“ˆå¯†ç“œé¦™èŠ‹", vg: 40, str: 20, flavors: [{name: "é¦™ç²¾", pct: 30}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-æ¡ƒå­é›ªç¢§", vg: 40, str: 20, flavors: [{name: "é¦™ç²¾", pct: 26}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}] },
        { name: "NM-å±±ç«¹æ¡‚åœ†æ¨æ¡ƒ", vg: 40, str: 20, flavors: [{name: "é¦™ç²¾", pct: 30}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4}, {name: "é…¸å‘³å‰‚", pct: 0.5}] },
        { name: "NM-èœ‚èœœæŸšå­èŒ¶", vg: 50, str: 20, flavors: [{name: "é¦™ç²¾", pct: 30}, {name: "ç”œå‘³å‰‚", pct: 1}, {name: "å‡‰å‘³å‰‚", pct: 4.5}] }
    ];

    let flavors = JSON.parse(JSON.stringify(PRESET_RECIPES[0].flavors));
    let recipeBook = JSON.parse(localStorage.getItem('myVapeRecipes') || '[]');

    const els = {
        targetVol: document.getElementById('targetVol'),
        targetStr: document.getElementById('targetStr'),
        targetVgSlider: document.getElementById('targetVgSlider'),
        vgDisplay: document.getElementById('vgDisplay'),
        pgDisplay: document.getElementById('pgDisplay'),
        baseStr: document.getElementById('baseStr'),
        baseType: document.getElementById('baseType'),
        recipeName: document.getElementById('recipeName'),
        flavorsContainer: document.getElementById('flavorsContainer'),
        resultBody: document.getElementById('resultBody'),
        totalMl: document.getElementById('totalMl'),
        warningBox: document.getElementById('warning-box'),
        recipeLibrary: document.getElementById('recipeLibrary'),
        presetLibrarySection: document.getElementById('presetLibrarySection'),
        presetLibrary: document.getElementById('presetLibrary'),
        presetChevron: document.getElementById('presetChevron')
    };

    function calculate() {
        const vol = parseFloat(els.targetVol.value) || 0;
        const targetNic = parseFloat(els.targetStr.value) || 0;
        const targetVgPct = parseInt(els.targetVgSlider.value);
        const targetPgPct = 100 - targetVgPct;
        const baseStr = parseFloat(els.baseStr.value) || 0;
        const baseVgPct = parseInt(els.baseType.value);
        
        els.vgDisplay.innerText = targetVgPct;
        els.pgDisplay.innerText = targetPgPct;
        els.warningBox.classList.add('hidden');

        if (vol <= 0) {
            els.resultBody.innerHTML = '';
            els.totalMl.innerText = '0.00';
            return;
        }

        let nicVol = baseStr > 0 ? (targetNic * vol) / baseStr : 0;
        let flavVol = 0;
        let flavHtml = '';
        
        flavors.forEach(f => {
            let fv = vol * (f.pct / 100);
            flavVol += fv;
            if(fv > 0) flavHtml += renderRow(f.name || 'é¦™ç²¾', fv, (fv/vol*100), 'text-purple-300 font-medium');
        });

        let nicPg = nicVol * ((100 - baseVgPct)/100);
        let nicVg = nicVol * (baseVgPct/100);
        let extraVg = (vol * targetVgPct/100) - nicVg;
        let extraPg = (vol * targetPgPct/100) - nicPg - flavVol;

        if (extraVg < -0.01 || extraPg < -0.01) {
            els.warningBox.classList.remove('hidden');
            els.warningBox.innerText = `âš ï¸ æº¢å‡ºè­¦å‘Šï¼šå½“å‰æ¯”ä¾‹æ— æ³•å®ç°ã€‚`;
        }

        let html = '';
        if(nicVol > 0) html += renderRow(`å°¼å¤ä¸ (${baseStr}mg)`, nicVol, (nicVol/vol*100), 'text-red-400 font-bold');
        html += flavHtml;
        html += renderRow('ç”˜æ²¹ (VG)', Math.max(0, extraVg), (Math.max(0, extraVg)/vol*100), 'text-green-400 font-bold');
        html += renderRow('ä¸™äºŒé†‡ (PG)', Math.max(0, extraPg), (Math.max(0, extraPg)/vol*100), 'text-sky-400 font-bold');
        
        els.resultBody.innerHTML = html;
        els.totalMl.innerText = vol.toFixed(2);
    }

    function renderRow(n, v, p, c) {
        return `<tr class="border-b border-slate-700/30">
            <td class="px-6 py-4 ${c} text-xs">${n}</td>
            <td class="px-6 py-4 text-right font-mono font-bold text-white text-lg">${v.toFixed(2)}</td>
            <td class="pr-6 py-4 text-right text-slate-400 font-mono text-sm font-bold tracking-tight">${p.toFixed(1)}%</td>
        </tr>`;
    }

    function addFlavor() { flavors.push({ name: '', pct: 0 }); renderFlavors(); }
    function removeFlavor(i) { flavors.splice(i, 1); renderFlavors(); }

    function renderFlavors() {
        els.flavorsContainer.innerHTML = '';
        flavors.forEach((f, i) => {
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center';
            div.innerHTML = `
                <input type="text" value="${f.name}" oninput="flavors[${i}].name=this.value;calculate()" placeholder="åç§°" class="flex-1 bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-white outline-none focus:border-purple-500">
                <div class="flex items-center bg-slate-900 border border-slate-700 rounded-xl px-3">
                    <input type="number" value="${f.pct}" oninput="flavors[${i}].pct=parseFloat(this.value)||0;calculate()" class="w-12 bg-transparent py-3 text-sm text-right text-white font-mono outline-none">
                    <span class="text-slate-600 text-[10px] ml-1">%</span>
                </div>
                <button onclick="removeFlavor(${i})" class="text-slate-500 hover:text-red-500 p-2 text-2xl">&times;</button>
            `;
            els.flavorsContainer.appendChild(div);
        });
        calculate();
    }

    function togglePresets() {
        const isCollapsed = els.presetLibrarySection.classList.contains('collapsed');
        els.presetLibrarySection.classList.toggle('collapsed', !isCollapsed);
        els.presetLibrarySection.classList.toggle('expanded', isCollapsed);
        els.presetChevron.style.transform = isCollapsed ? 'rotate(180deg)' : 'rotate(0deg)';
    }

    function renderPresets() {
        document.getElementById('presetCount').innerText = PRESET_RECIPES.length;
        els.presetLibrary.innerHTML = '';
        PRESET_RECIPES.forEach(r => {
            const btn = document.createElement('button');
            btn.className = 'bg-slate-800 border border-slate-700 p-3 rounded-2xl text-left hover:border-sky-500/50 active:scale-95 transition-all';
            btn.onclick = () => {
                els.recipeName.value = r.name;
                els.targetStr.value = r.str;
                els.targetVgSlider.value = r.vg;
                flavors = JSON.parse(JSON.stringify(r.flavors));
                renderFlavors();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            btn.innerHTML = `<p class="text-[10px] font-bold text-sky-400 truncate mb-1">${r.name}</p><p class="text-[8px] text-slate-500 font-bold uppercase">å¯¼å…¥</p>`;
            els.presetLibrary.appendChild(btn);
        });
    }

    function saveCurrentRecipe() {
        const recipe = { id: Date.now(), name: els.recipeName.value.trim() || "æœªå‘½åé…æ–¹", vol: els.targetVol.value, str: els.targetStr.value, vg: els.targetVgSlider.value, flavors: JSON.parse(JSON.stringify(flavors)) };
        recipeBook.unshift(recipe);
        localStorage.setItem('myVapeRecipes', JSON.stringify(recipeBook));
        renderLibrary();
        alert('é…æ–¹å·²å­˜è‡³æœ¬åœ°åº“');
    }

    function renderLibrary() {
        els.recipeLibrary.innerHTML = recipeBook.length ? '' : '<p class="text-slate-600 text-[10px] italic py-4 col-span-full text-center">æš‚æ— æœ¬åœ°æ”¶è—</p>';
        recipeBook.forEach(r => {
            const card = document.createElement('div');
            card.className = 'bg-slate-900/80 border border-slate-700 p-4 rounded-2xl flex justify-between items-center';
            card.innerHTML = `
                <div class="truncate mr-4">
                    <p class="font-bold text-[11px] text-slate-200 truncate">${r.name}</p>
                    <p class="text-[9px] text-slate-500 font-mono mt-0.5">${r.vg}VG / ${r.str}MG</p>
                </div>
                <div class="flex gap-1">
                    <button onclick='loadSaved(${JSON.stringify(r)})' class="text-[9px] text-yellow-500 font-bold px-3 py-2 bg-yellow-500/10 rounded-lg">åŠ è½½</button>
                    <button onclick="deleteRecipe(${r.id})" class="text-[9px] text-red-500 font-bold px-2 py-2">&times;</button>
                </div>`;
            els.recipeLibrary.appendChild(card);
        });
    }

    window.loadSaved = (r) => {
        els.recipeName.value = r.name;
        els.targetVol.value = r.vol;
        els.targetStr.value = r.str;
        els.targetVgSlider.value = r.vg;
        flavors = JSON.parse(JSON.stringify(r.flavors));
        renderFlavors();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.deleteRecipe = (id) => {
        if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
        recipeBook = recipeBook.filter(x => x.id !== id);
        localStorage.setItem('myVapeRecipes', JSON.stringify(recipeBook));
        renderLibrary();
    };

    window.resetCalculator = () => { if(confirm('é‡ç½®æ‰€æœ‰æ•°æ®ï¼Ÿ')) location.reload(); };
    document.querySelectorAll('input').forEach(el => el.addEventListener('input', calculate));
    els.targetVgSlider.addEventListener('input', calculate);

    renderFlavors();
    renderLibrary();
    renderPresets();
</script>
</body>
</html>
